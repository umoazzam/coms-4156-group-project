<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Columbia University Library - Required Readings</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="university-logo">
                <h1>Columbia University Libraries</h1>
                <p class="subtitle">Academic Resource Management System</p>
            </div>
        </header>

        <main class="main-content">
            <div class="course-header">
                <h2 class="course-title">COMS W 4156: Advanced Software Engineering</h2>
                <h3 class="page-title">Required Readings</h3>
                <p class="semester-info">Fall 2024 | Prof. Gail Kaiser</p>
            </div>

            {% if service_status %}
            <div class="status-indicator success">
                <span class="status-dot"></span>
                Citation Service: Connected
            </div>
            {% else %}
            <div class="status-indicator error">
                <span class="status-dot"></span>
                Citation Service: Unavailable
            </div>
            {% endif %}

            <div class="readings-list">
                {% for reading in readings %}
                <div class="reading-item">
                    <div class="reading-header">
                        <span class="reading-type {{ reading.type.lower() }}">{{ reading.type }}</span>
                        <h4 class="reading-title">{{ reading.title }}</h4>
                    </div>

                    <div class="reading-details">
                        <p class="author"><strong>Author:</strong> {{ reading.author }}</p>
                        {% if reading.type == 'BOOK' %}
                            {% if reading.publisher %}<p><strong>Publisher:</strong> {{ reading.publisher }}</p>{% endif %}
                            {% if reading.isbn %}<p><strong>ISBN:</strong> {{ reading.isbn }}</p>{% endif %}
                        {% elif reading.type == 'ARTICLE' %}
                            {% if reading.journal %}<p><strong>Journal:</strong> {{ reading.journal }}</p>{% endif %}
                            {% if reading.doi %}<p><strong>DOI:</strong> {{ reading.doi }}</p>{% endif %}
                            {% if reading.volume %}<p><strong>Volume:</strong> {{ reading.volume }}</p>{% endif %}
                            {% if reading.issue %}<p><strong>Issue:</strong> {{ reading.issue }}</p>{% endif %}
                            {% if reading.pages %}<p><strong>Pages:</strong> {{ reading.pages }}</p>{% endif %}
                        {% elif reading.type == 'VIDEO' %}
                            {% if reading.platform %}<p><strong>Platform:</strong> {{ reading.platform }}</p>{% endif %}
                            {% if reading.url %}<p><strong>URL:</strong> <a href="{{ reading.url }}" target="_blank">{{ reading.url }}</a></p>{% endif %}
                            {% if reading.duration %}<p><strong>Duration:</strong> {{ reading.duration // 60 }}:{{ '{:02d}'.format(reading.duration % 60) }}</p>{% endif %}
                        {% endif %}
                        {% if reading.year %}<p><strong>Year:</strong> {{ reading.year }}</p>{% endif %}
                    </div>

                    <div class="citation-controls">
                        <div class="citation-form">
                            <label for="style-{{ reading.id }}" class="style-label">Citation Style:</label>
                            <select id="style-{{ reading.id }}" class="style-select">
                                <option value="MLA">MLA</option>
                                <option value="APA">APA</option>
                                <option value="CHICAGO">Chicago</option>
                            </select>
                            <button class="generate-btn" onclick="generateCitation({{ reading.id }})">
                                Generate Citation
                            </button>
                        </div>

                        <div id="citation-{{ reading.id }}" class="citation-result" style="display: none;">
                            <h5>Generated Citation:</h5>
                            <div class="citation-text"></div>
                            <button class="copy-btn" onclick="copyCitation({{ reading.id }})">Copy to Clipboard</button>
                        </div>

                        <div id="loading-{{ reading.id }}" class="loading" style="display: none;">
                            <div class="spinner"></div>
                            <span>Generating citation...</span>
                        </div>

                        <div id="error-{{ reading.id }}" class="error-message" style="display: none;"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </main>

        <footer class="footer">
            <p>&copy; 2024 Columbia University Libraries | Citation Service Integration Demo</p>
            <p>This application demonstrates integration with the Citation Service API for academic resource management.</p>
        </footer>
    </div>

    <script>
        async function generateCitation(sourceId) {
            const styleSelect = document.getElementById(`style-${sourceId}`);
            const style = styleSelect.value;
            const citationDiv = document.getElementById(`citation-${sourceId}`);
            const loadingDiv = document.getElementById(`loading-${sourceId}`);
            const errorDiv = document.getElementById(`error-${sourceId}`);
            const generateBtn = document.querySelector(`button[onclick="generateCitation(${sourceId})"]`);

            // Hide previous results
            citationDiv.style.display = 'none';
            errorDiv.style.display = 'none';

            // Show loading state
            loadingDiv.style.display = 'flex';
            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating...';

            try {
                const response = await fetch('/generate_citation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        source_id: sourceId,
                        style: style
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const citationText = citationDiv.querySelector('.citation-text');
                    citationText.textContent = data.citation;
                    citationDiv.style.display = 'block';
                } else {
                    errorDiv.textContent = data.error || 'Failed to generate citation';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Network error: Unable to generate citation';
                errorDiv.style.display = 'block';
            } finally {
                // Hide loading state
                loadingDiv.style.display = 'none';
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generate Citation';
            }
        }

        async function copyCitation(sourceId) {
            const citationText = document.querySelector(`#citation-${sourceId} .citation-text`).textContent;

            try {
                await navigator.clipboard.writeText(citationText);

                const copyBtn = document.querySelector(`#citation-${sourceId} .copy-btn`);
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'Copied!';
                copyBtn.classList.add('copied');

                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.classList.remove('copied');
                }, 2000);
            } catch (error) {
                console.error('Failed to copy citation:', error);
                alert('Failed to copy citation to clipboard');
            }
        }

        // Check service status on page load
        document.addEventListener('DOMContentLoaded', function() {
            const statusIndicator = document.querySelector('.status-indicator');
            if (!statusIndicator.classList.contains('success')) {
                // Show warning for unavailable service
                const warning = document.createElement('div');
                warning.className = 'service-warning';
                warning.innerHTML = '<strong>Note:</strong> Citation generation is currently unavailable. Please ensure the Citation Service is running on localhost:8080.';
                document.querySelector('.main-content').insertBefore(warning, document.querySelector('.readings-list'));
            }
        });
    </script>
</body>
</html>
